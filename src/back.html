<!---------- Header ------------->
<header>
  <div class="top-container">
    <!-- Show the frequency number -->
    {{FreqSort}}

    <!-- The frequency dropdown icon -->
    {{#Frequency}}
      <span class="freq-dropdown">
        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" class="dropdown-arrow-svg" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"></path>
            <path d="M 12.7,6.5 H 3.3 L 8,11 Z"></path>
        </svg>
      </span>
    {{/Frequency}}

    <!-- The frequency list -->
    <div class="freq-list-container"></div>
  </div>
</header>

<main>
  <div class="template">

    <!-- The first row (vocab box+picture) -->
    <div class="def-header">
      <div class="dh-left">
        <div class="show-furigana vocab">
          {{#ExpressionFurigana}}{{furigana:ExpressionFurigana}}{{/ExpressionFurigana}}
          {{^ExpressionFurigana}}{{Expression}}{{/ExpressionFurigana}}
        </div>

        <!-- Reading + Pitch Accent -->
				<div class="info">
        <div class="audio-buttons">{{ExpressionAudio}} {{SentenceAudio}}</div>
      </div>
      </div>

      <!-- Image -->
      <div class="dh-right">
        {{#Picture}}
          <div class="image {{Tags}}">{{Picture}}</div>
        {{/Picture}}
      </div>
    </div>

    <br>
    <div class="sentence">
      {{#SentenceFurigana}} {{furigana:SentenceFurigana}} {{/SentenceFurigana}}
      {{^SentenceFurigana}} {{furigana:Sentence}} {{/SentenceFurigana}}
    </div>

  <!-- The entire definition blockquote -->
  <div class="def-info-container"><div class="def-info"></div></div>
    <blockquote class="main-def def-blockquote">
      <div class="definition">
        {{#SelectionText}}{{SelectionText}}{{/SelectionText}}
      </div>
    </blockquote>

  <!-- This is for the sentence that you see on mobile (positioned under definition), on Desktop, the sentence goes above the definition box, and this is hidden -->
  <div class="sentence-mobile">
    {{#SentenceFurigana}} {{furigana:SentenceFurigana}} {{/SentenceFurigana}}
    {{^SentenceFurigana}} {{furigana:Sentence}} {{/SentenceFurigana}}
  </div>

  <!------- Image modal --------->
  <div class="modal-bg"></div>
  <div class="img-popup"></div>

  {{#MiscInfo}}
    <div style="text-align: center">
      <div>
        <details>
          <summary>Misc. info</summary>
          <div class="misc-info popup">
            === Details ===
            <br />
            {{MiscInfo}}
          </div>
        </details>
      </div>
    </div>
  {{/MiscInfo}}
</main>

<!----------- Footer ------------->
<footer>
  <br>
  <div class="bot-container">
    {{#Tags}}
    <div class="tags-container">
      <div class="tags">{{Tags}}</div>
    </div>
    {{/Tags}}
  </div>
</footer>

<!----------- Scripts ------------>
<script>

  // Seperate Tags by space, and show them in their own boxes
  function tweakHTML() {
    // Split tags
    const tagsContainer = document.querySelector(".tags-container");
    const tags = `{{Tags}}`.split(" ");
    if (tagsContainer) {
      tagsContainer.innerHTML = "";
      for (tag of tags) {
        const tagElem = document.createElement("div");
        tagElem.className = "tags";
        tagElem.innerText = tag;
        tagsContainer.appendChild(tagElem);
      }
    }
  }
  function decode_pinyin(pinyin) {
    // From Destroyer862K2 in https://www.reddit.com/r/Anki/comments/i6rmp6/chinese_flashcards_automatic_coloring_according/
    const core = ["a", "e", "i", "o", "u", "ü"];
    let arr = pinyin.replace(/<b>|<\/b>|<div>|<\/div>/g, "").split("");

    is_core = function (c, c_previous_two = "", c_next = "") {
      //pre conditions
      if (
        c == "r" &&
        (c_next == " " || c_next == "") &&
        c_previous_two != " " &&
        c_previous_two != ""
      ) {
        return [true, true];
      }
      //pre conditions

      c = c
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase();
      for (let i = 0; i < core.length; i++) {
        if (c === core[i]) {
          return [true, false];
        }
      }
      return [false, false];
    };
    get_tone = function (str) {
      let pure = str.replace(/a|e|i|o|u|ü|r/g, "");
      if (pure == "") {
        return 5;
      } else if (["ā", "ē", "ī", "ō", "ū", "ǖ"].includes(pure)) {
        return 1;
      } else if (["á", "é", "í", "ó", "ú", "ǘ"].includes(pure)) {
        return 2;
      } else if (["ǎ", "ě", "ǐ", "ǒ", "ǔ", "ǚ"].includes(pure)) {
        return 3;
      } else if (["à", "è", "ì", "ò", "ù", "ǜ"].includes(pure)) {
        return 4;
      }

      return pure;
    };

    let tones_arr = [];
    let buff = [];

    flush = function () {
      if (buff.length > 0) {
        tones_arr.push(get_tone(buff.join("")));
        buff = [];
      }
    };
    for (let i = 0; i < arr.length; i++) {
      let res = is_core(arr[i], arr[i - 2], arr[i + 1]);
      if (res[1]) {
        flush();
      }
      if (res[0]) {
        buff.push(arr[i]);
      } else {
        flush();
      }
    }
    if (buff.length > 0) {
      tones_arr.push(get_tone(buff.join("")));
      buff = [];
    }
    return tones_arr;
  }

  function getTonePattern(reading) {
    //console.log("pinyin reading, tone pattern:", decode_pinyin(reading));
    return decode_pinyin(reading);
  }
  function addToneColor(tonePattern, targetWordEl) {
    const innerText = targetWordEl.innerText.split("");
    let newInnerHtml = "";
    if (tonePattern.length === targetWordEl.innerText.length) {
      for (let i = 0; i < tonePattern.length; i++) {
        newInnerHtml += `<span class="tone${tonePattern[i]}">${innerText[i]}</span>`;
      }
    } else {
      return;
    }
    targetWordEl.innerHTML = newInnerHtml;
  }
  function paintTargetWord() {
    const wordTranscription = `{{ExpressionReading}}`;
    if (!wordTranscription) return;

    const tonePattern = getTonePattern(wordTranscription);

    const sentences = Array.from(
      document.querySelectorAll(".sentence, .definition, .sentence-mobile")
    );
    for (const sentence of sentences) {
      for (const targetWord of sentence.getElementsByTagName("b")) {
        addToneColor(tonePattern, targetWord);
      }
    }

    const vocabElement = document.querySelector(".vocab ruby rb");
    if (vocabElement !== null) {
      addToneColor(tonePattern, vocabElement);
    }
  }
  

  // Helper function to check if a field is just html without any content
  function isAllHtml(content) {
    const strippedContent = content.replace(/<\/?[^>]+(>|$)/g, "").trim();
    return strippedContent === "" && content.match(/<\/?[^>]+(>|$)/g) !== null;
  }

  // This function handles toggling definitions with click/key
  function toggleDef(index) {
    let dictNames = [];
    if (`{{SelectionText}}`) dictNames.push("Text Selection");
    if (`{{MainDefinition}}` && isAllHtml(`{{MainDefinition}}`) == false) dictNames.push("Primary Definition");
    if (`{{Glossary}}`) dictNames.push("Glossaries");

    const definitionContainer = document.querySelector(
      ".main-def > .definition",
    );

    const indexDisplay = document.querySelector(".def-info");
    indexDisplay.style.opacity = 1;

    currentIndex = index % dictNames.length;
    while (currentIndex < 0) currentIndex += dictNames.length;

    indexDisplay.innerText = `${dictNames[currentIndex]} ${currentIndex + 1}/${
      dictNames.length
    }`;

    if (dictNames[currentIndex].toLowerCase().includes("text selection")) {
      definitionContainer.innerHTML = `{{SelectionText}}`;
    }
    else if (dictNames[currentIndex].toLowerCase().includes("primary definition")) {
      definitionContainer.innerHTML = `<div id="primary">{{MainDefinition}}</div>`;
      hideCorrectDefinition();
    }
    else if (dictNames[currentIndex].toLowerCase().includes("glossar"))
      definitionContainer.innerHTML = `<div id="glossaries">{{Glossary}}</div>`;
  }

  function setUpDefToggle() {
    const mainDefContainer = document.querySelector(".main-def");

    const leftEdge = document.createElement("div");
    const rightEdge = document.createElement("div");
    leftEdge.classList.add("left-edge");
    leftEdge.classList.add("tappable");
    rightEdge.classList.add("right-edge");
    rightEdge.classList.add("tappable");
    mainDefContainer.appendChild(leftEdge);
    mainDefContainer.appendChild(rightEdge);

    let index = 0;

    leftEdge.addEventListener("click", (e) => {
      index -= 1;
      toggleDef(index);
    });

    rightEdge.addEventListener("click", (e) => {
      index += 1;
      toggleDef(index);
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") index -= 1;
      else if (e.key === "ArrowRight") index += 1;

      toggleDef(index);
    });
  }

  // By default, it's going to be SelectionText in that field, but what if it is empty i.e user has not selected any text?
  function showCorrectDef() {
    const selectionText = document.querySelector(".main-def > .definition");
    if ((selectionText.innerHTML.trim() == "" && `{{MainDefinition}}`) && isAllHtml(`{{MainDefinition}}`) == false) {
      selectionText.innerHTML = `<div id="primary">{{MainDefinition}}</div>`;
    }
    else if (selectionText.innerHTML.trim() == "" && `{{MainDefinition}}` == "" || isAllHtml(`{{MainDefinition}}`) == true)
      selectionText.innerHTML = `<div id="glossaries">{{Glossary}}</div>`;
    }

  // This just handles clicking and showing images
  function clickImage() {
      const modalBg = document.querySelector(".modal-bg");
      const imgPopup = document.querySelector(".img-popup");
      const image = document.querySelector(".image img");

      if (!image) return;

      image.addEventListener("click", () => {
          const imgPopupContainer = document.createElement("div");
          const imgPopupImg = document.createElement("img");

          imgPopupContainer.classList.add("img-popup-container");
          imgPopupImg.src = image.src;
          imgPopupImg.classList.add("img-popup-img");

          if (image.height > image.width) {
              imgPopupContainer.style.height = "calc(100% - 20px)";
              imgPopupContainer.style.width = "max-content";
          }
          imgPopup.innerHTML = "";
          imgPopup.appendChild(imgPopupContainer);
          imgPopupContainer.appendChild(imgPopupImg);

          document.body.classList.add("img-popup");
          modalBg.style.display = "block";
          imgPopupContainer.style.display = "flex";
      });

      modalBg.addEventListener("click", () => {
          document.body.classList.remove("img-popup");
          modalBg.style.display = "none";
          imgPopup.innerHTML = "";
      });
  }

  // Handles what you see when you hover over frequency dropdown icon
  function frequencyHover() {
      const hoverTrigger = document.querySelector('.freq-dropdown');
      const frequencyElement = document.querySelector('.freq-list-container');

      hoverTrigger.addEventListener('mouseenter', function() {
          frequencyElement.innerHTML = `
              {{#Frequency}} {{Frequency}} {{/Frequency}}
          `;
          frequencyElement.classList.add('visible');
      });

      hoverTrigger.addEventListener('mouseleave', function() {
          frequencyElement.classList.remove('visible');
      });
  }

  // Sets the height of dhLeft, dhRight, defHeader as a whole
  function setDHHeight() {
    var dhLeft = document.querySelector('.dh-left');
    var dhRight = document.querySelector('.dh-right .image img');
    var defHeader = document.querySelector('.def-header')

    if (dhLeft && dhRight) {
        var dhLeftHeight = dhLeft.offsetHeight;
        dhRight.style.maxHeight = `${dhLeftHeight}px`;
        defHeader.style.maxHeight = `${dhLeftHeight}px`;
    }
  }

  // Hides the dictionary user selected in MainDefinition in Glossary field, if any
  function hideCorrectDefinition() {
    let primaryElement = document.querySelector("#primary li[data-dictionary]");
    console.log(primaryElement);

    if (primaryElement) {
        let dictionaryValue = primaryElement.getAttribute("data-dictionary");
        let style = document.createElement('style');

        style.type = 'text/css';
        const cssRules = `#glossaries li[data-dictionary="${dictionaryValue}"] { display:none !important; }`
        style.appendChild(document.createTextNode(cssRules));
        document.head.appendChild(style);
    }
  }

  // Initialize all functions!!!
  function initialize() {
    tweakHTML();
    paintTargetWord();
    showCorrectDef();
    setUpDefToggle();
    clickImage();
    frequencyHover();
    setDHHeight();
    hideCorrectDefinition();
  }

  initialize();
</script>